
import { GoogleGenAI } from "@google/genai";
import type { Settings } from '../types';

// Helper to get the AI client instance
const getAiClient = (apiKey: string) => {
  return new GoogleGenAI({ apiKey });
};

export const generateImage = async (prompt: string, aspectRatio: Settings['aspectRatio'], numImages: number, apiKey: string): Promise<string[]> => {
    if (!apiKey) throw new Error("API Key is required");
    
    const ai = getAiClient(apiKey);
    
    try {
        // Switch to gemini-2.5-flash-image to support free tier keys.
        // This model requires 'generateContent' and does not support 'numberOfImages' in config like Imagen.
        // We must fire parallel requests to generate multiple images.
        const promises = Array.from({ length: numImages }).map(async () => {
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash-image',
                contents: {
                    parts: [{ text: prompt }]
                },
                config: {
                    imageConfig: {
                        aspectRatio: aspectRatio,
                    }
                },
            });

            // Extract base64 data from the response parts
            for (const part of response.candidates?.[0]?.content?.parts || []) {
                if (part.inlineData) {
                    return part.inlineData.data;
                }
            }
            return null;
        });

        const results = await Promise.all(promises);
        const images = results.filter((img): img is string => img !== null);

        if (images.length > 0) {
            return images;
        } else {
            throw new Error("No image generated by the API.");
        }
    } catch (error: any) {
        console.error("Gemini API Error:", error);
        throw new Error(error.message || String(error));
    }
};

export const generateTitle = async (prompt: string, apiKey: string): Promise<string> => {
    if (!apiKey) return "Untitled Artwork";
    
    try {
        const ai = getAiClient(apiKey);
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: `Create a single, concise, and artistic title (maximum 4 words) for an image generated from the following prompt. Do not provide suggestions, alternatives, or quotation marks. Just the title. Prompt: "${prompt}"`,
        });
        return response.text?.trim().replace(/"/g, '') || "Untitled Artwork";
    } catch (error) {
        console.error("Title generation failed:", error);
        return "Untitled Artwork";
    }
};
